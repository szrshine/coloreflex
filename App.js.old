import { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import {
  StyleSheet,
  Text,
  View,
  TouchableOpacity,
  Animated,
  Dimensions,
  Linking,
  Modal,
  ScrollView,
  Switch,
  ActivityIndicator,
} from 'react-native';
import { StatusBar } from 'expo-status-bar';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Audio } from 'expo-av';
import * as Haptics from 'expo-haptics';
import {
  initializeAdMob,
  loadInterstitialAd,
  showInterstitialAd,
  isInterstitialReady,
  loadRewardedAd,
  showRewardedAd,
  isRewardedAdReady,
  initializeIAP,
  loadProducts,
  purchaseProduct,
  restorePurchases,
  hasRemovedAds,
  hasPremiumSkins,
  getAvailableProducts,
  AdMobBanner,
  BannerAdSize,
  AD_UNIT_IDS,
  IAP_PRODUCT_IDS,
} from './monetization';
import { COLORS } from './src/constants/colors';
import { SKINS } from './src/constants/skins';
import { POWERUPS } from './src/constants/powerups';
import { ACHIEVEMENTS_LIST } from './src/constants/achievements';
import { privacyPolicyText, termsOfServiceText } from './src/constants/legalText';
import { BALL_SIZE, INITIAL_SPEED, SPEED_INCREMENT } from './src/constants/gameConfig';

// Screen Components
import MenuScreen from './src/screens/MenuScreen';
import GameScreen from './src/screens/GameScreen';
import GameOverScreen from './src/screens/GameOverScreen';
import TutorialScreen from './src/screens/TutorialScreen';
import SkinsScreen from './src/screens/SkinsScreen';
import PowerupsScreen from './src/screens/PowerupsScreen';
import AchievementsScreen from './src/screens/AchievementsScreen';
import DailyTasksScreen from './src/screens/DailyTasksScreen';
import StoreScreen from './src/screens/StoreScreen';

// Game Components
import Ball from './src/components/game/Ball';
import Particle from './src/components/game/Particle';

// UI Components
import SettingsModal from './src/components/ui/SettingsModal';

const { width, height } = Dimensions.get('window');

export default function App() {
  const [gameState, setGameState] = useState('menu'); // menu, playing, gameOver, tutorial, achievements, stats, store, dailyTasks
  const [score, setScore] = useState(0);
  const [highScore, setHighScore] = useState(0);
  const [balls, setBalls] = useState([]);
  const [speed, setSpeed] = useState(INITIAL_SPEED);
  const [particles, setParticles] = useState([]); // ParÃ§acÄ±k efektleri iÃ§in
  // Ä°lk deÄŸer: Manuel hesaplama (toplar iÃ§in), sonra onLayout ile gerÃ§ek deÄŸer gÃ¼ncellenecek
  const [boxContainerY, setBoxContainerY] = useState(height - 160 - 95); // scoreBar(95) Ã§Ä±karÄ±lmÄ±ÅŸ
  const [modalVisible, setModalVisible] = useState(false);
  const [modalContent, setModalContent] = useState('');
  const [modalTitle, setModalTitle] = useState('');
  const [tutorialStep, setTutorialStep] = useState(0);
  const [showTutorial, setShowTutorial] = useState(false);
  const [settingsVisible, setSettingsVisible] = useState(false); // Ayarlar modal
  const [previousGameState, setPreviousGameState] = useState('menu'); // Ayarlar Ã¶ncesi state

  // Ayarlar state'leri
  const [soundEnabled, setSoundEnabled] = useState(true);
  const [musicEnabled, setMusicEnabled] = useState(true);
  const [hapticEnabled, setHapticEnabled] = useState(true);

  // Ä°statistikler state'leri
  const [totalGamesPlayed, setTotalGamesPlayed] = useState(0);
  const [totalScore, setTotalScore] = useState(0);
  const [totalCorrectMatches, setTotalCorrectMatches] = useState(0);
  const [totalWrongMatches, setTotalWrongMatches] = useState(0);
  const [longestStreak, setLongestStreak] = useState(0);
  const [currentStreak, setCurrentStreak] = useState(0);

  // BaÅŸarÄ±mlar state'leri
  const [achievements, setAchievements] = useState({});
  const [unlockedAchievements, setUnlockedAchievements] = useState([]);
  const [sessionAchievements, setSessionAchievements] = useState([]); // Bu oyun oturumunda kazanÄ±lan baÅŸarÄ±mlar

  // GÃ¼nlÃ¼k gÃ¶revler ve Ã¶dÃ¼ller
  const [dailyLoginStreak, setDailyLoginStreak] = useState(0);
  const [lastLoginDate, setLastLoginDate] = useState('');
  const [dailyTasks, setDailyTasks] = useState([]);
  const [dailyRewardClaimed, setDailyRewardClaimed] = useState(false);

  // Monetizasyon state'leri
  const [coins, setCoins] = useState(0);
  const [adsRemoved, setAdsRemoved] = useState(false);
  const [premiumSkinsOwned, setPremiumSkinsOwned] = useState(false);
  const [iapProducts, setIapProducts] = useState([]);
  const [iapLoading, setIapLoading] = useState(false);
  const [gamesPlayedSinceAd, setGamesPlayedSinceAd] = useState(0);
  const [continueUsesToday, setContinueUsesToday] = useState(0);
  const [countdown, setCountdown] = useState(0); // Devam etmeden Ã¶nce geri sayÄ±m

  // Skin state'leri
  const [selectedSkin, setSelectedSkin] = useState('default');
  const [ownedSkins, setOwnedSkins] = useState(['default']);

  // Power-up state'leri
  const [powerupInventory, setPowerupInventory] = useState({
    slowmotion: 0,
    shield: 0,
    freeze: 0,
  });
  const [activePowerup, setActivePowerup] = useState(null);
  const [shieldActive, setShieldActive] = useState(false);
  const shieldActiveRef = useRef(false); // Shield'Ä±n gerÃ§ek zamanlÄ± durumu
  const shieldUsedBallsRef = useRef(new Set()); // Shield ile kaldÄ±rÄ±lan toplarÄ±n ID'lerini sakla
  const powerupTimeoutRef = useRef(null);
  const [powerupPurchasePopup, setPowerupPurchasePopup] = useState({ visible: false, message: '' });
  const powerupPopupTimeoutRef = useRef(null);
  const [shopPurchasePopup, setShopPurchasePopup] = useState({ visible: false, message: '' });
  const shopPopupTimeoutRef = useRef(null);

  const gameLoop = useRef(null);
  const ballIdCounter = useRef(0);
  const spawnTimer = useRef(0);
  const particleIdCounter = useRef(0);

  // Ses efektleri refs
  const correctSound = useRef(null);
  const wrongSound = useRef(null);
  const clickSound = useRef(null);
  const backgroundMusic = useRef(null);

  // Ä°lk yÃ¼kleme - yÃ¼ksek skor ve ayarlarÄ± yÃ¼kle
  useEffect(() => {
    loadHighScore();
    loadSettings();
    loadStats();
    loadAchievements();
    checkFirstLaunch();
    checkDailyLogin();
    loadSounds();
    initializeMonetization();
    loadCoins();
    loadSkins();
    loadPowerups();

    return () => {
      // Cleanup: ses dosyalarÄ±nÄ± unload et
      if (correctSound.current) correctSound.current.unloadAsync();
      if (wrongSound.current) wrongSound.current.unloadAsync();
      if (clickSound.current) clickSound.current.unloadAsync();
      if (backgroundMusic.current) backgroundMusic.current.unloadAsync();
    };
  }, []);

  // BaÅŸarÄ±mlar ekranÄ±na her giriÅŸte baÅŸarÄ±mlarÄ± yeniden yÃ¼kle
  useEffect(() => {
    if (gameState === 'achievements') {
      loadAchievements();
    }
  }, [gameState]);

  // Ä°lk aÃ§Ä±lÄ±ÅŸ kontrolÃ¼
  const checkFirstLaunch = async () => {
    try {
      const hasSeenTutorial = await AsyncStorage.getItem('hasSeenTutorial');
      if (!hasSeenTutorial) {
        setShowTutorial(true);
        setGameState('tutorial');
      }
    } catch (error) {
    }
  };

  // Ses dosyalarÄ±nÄ± yÃ¼kle
  const loadSounds = async () => {
    try {
      const { sound: correct } = await Audio.Sound.createAsync(
        require('./assets/sounds/correct.mp3')
      );
      correctSound.current = correct;

      const { sound: wrong } = await Audio.Sound.createAsync(
        require('./assets/sounds/wrong.mp3')
      );
      wrongSound.current = wrong;

      // Click sesi opsiyonel - yoksa hata vermesin
      try {
        const { sound: click } = await Audio.Sound.createAsync(
          require('./assets/sounds/click.mp3')
        );
        clickSound.current = click;
      } catch (e) {
      }

      const { sound: music } = await Audio.Sound.createAsync(
        require('./assets/sounds/background.mp3'),
        { isLooping: true, shouldPlay: false, volume: 0.6 }
      );
      backgroundMusic.current = music;

    } catch (error) {
    }
  };

  // Ses Ã§al fonksiyonu
  const playSound = async (soundRef) => {
    if (!soundEnabled || !soundRef.current) return;

    try {
      await soundRef.current.replayAsync();
    } catch (error) {
    }
  };

  // MÃ¼zik kontrol
  useEffect(() => {
    const controlMusic = async () => {
      if (!backgroundMusic.current) return;

      try {
        if (musicEnabled && gameState === 'playing' && !settingsVisible) {
          const status = await backgroundMusic.current.getStatusAsync();
          if (!status.isLoaded) {
            return;
          }
          if (!status.isPlaying) {
            await backgroundMusic.current.playAsync();
          }
        } else {
          const status = await backgroundMusic.current.getStatusAsync();
          if (status.isLoaded && status.isPlaying) {
            await backgroundMusic.current.pauseAsync();
          }
        }
      } catch (error) {
      }
    };

    controlMusic();
  }, [musicEnabled, gameState, settingsVisible]);

  // Haptic feedback fonksiyonu
  const triggerHaptic = (type = 'light') => {
    if (!hapticEnabled) return;

    try {
      switch (type) {
        case 'light':
          Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
          break;
        case 'medium':
          Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
          break;
        case 'heavy':
          Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Heavy);
          break;
        case 'success':
          Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
          break;
        case 'error':
          Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
          break;
      }
    } catch (error) {
    }
  };

  // AyarlarÄ± yÃ¼kle
  const loadSettings = async () => {
    try {
      const settings = await AsyncStorage.multiGet([
        'soundEnabled',
        'musicEnabled',
        'hapticEnabled'
      ]);

      settings.forEach(([key, value]) => {
        if (value !== null) {
          const boolValue = value === 'true';
          if (key === 'soundEnabled') setSoundEnabled(boolValue);
          if (key === 'musicEnabled') setMusicEnabled(boolValue);
          if (key === 'hapticEnabled') setHapticEnabled(boolValue);
        }
      });
    } catch (error) {
    }
  };

  // AyarlarÄ± kaydet
  const saveSetting = useCallback(async (key, value) => {
    try {
      await AsyncStorage.setItem(key, value.toString());
    } catch (error) {
    }
  }, []);

  const loadHighScore = async () => {
    try {
      const savedHighScore = await AsyncStorage.getItem('highScore');
      if (savedHighScore !== null) {
        setHighScore(parseInt(savedHighScore));
      }
    } catch (error) {
    }
  };

  const saveHighScore = async (newScore) => {
    try {
      if (newScore > highScore) {
        await AsyncStorage.setItem('highScore', newScore.toString());
        setHighScore(newScore);
        // Yeni rekor haptic ve ses efekti
        triggerHaptic('success');
        playSound(correctSound);
      }
    } catch (error) {
    }
  };

  // ============ MONETÄ°ZASYON FONKSÄ°YONLARI ============

  // Coin sistemi
  const loadCoins = async () => {
    try {
      const savedCoins = await AsyncStorage.getItem('coins');
      if (savedCoins !== null) {
        setCoins(parseInt(savedCoins));
      }
    } catch (error) {
    }
  };

  const saveCoins = async (newCoins) => {
    try {
      await AsyncStorage.setItem('coins', newCoins.toString());
      setCoins(newCoins);
    } catch (error) {
    }
  };

  const addCoins = async (amount) => {
    try {
      // Mevcut coin deÄŸerini AsyncStorage'dan al (en gÃ¼ncel deÄŸer)
      const savedCoins = await AsyncStorage.getItem('coins');
      const currentCoins = savedCoins ? parseInt(savedCoins) : 0;
      const newCoins = currentCoins + amount;
      await saveCoins(newCoins);
    } catch (error) {
    }
  };

  const spendCoins = async (amount) => {
    if (coins >= amount) {
      const newCoins = coins - amount;
      await saveCoins(newCoins);
      return true;
    }
    return false;
  };

  // Skin yÃ¼kleme ve kaydetme
  const loadSkins = async () => {
    try {
      const savedSkin = await AsyncStorage.getItem('selectedSkin');
      if (savedSkin) setSelectedSkin(savedSkin);

      const savedOwnedSkins = await AsyncStorage.getItem('ownedSkins');
      if (savedOwnedSkins) {
        setOwnedSkins(JSON.parse(savedOwnedSkins));
      }
    } catch (error) {
    }
  };

  const saveSkinSelection = async (skinId) => {
    try {
      await AsyncStorage.setItem('selectedSkin', skinId);
      setSelectedSkin(skinId);
    } catch (error) {
    }
  };

  const saveOwnedSkinsToStorage = async (skins) => {
    try {
      await AsyncStorage.setItem('ownedSkins', JSON.stringify(skins));
      setOwnedSkins(skins);
    } catch (error) {
    }
  };

  // Power-up yÃ¼kleme ve kaydetme
  const loadPowerups = async () => {
    try {
      const savedInventory = await AsyncStorage.getItem('powerupInventory');
      if (savedInventory) {
        setPowerupInventory(JSON.parse(savedInventory));
      }
    } catch (error) {
    }
  };

  const savePowerupInventory = async (inventory) => {
    try {
      await AsyncStorage.setItem('powerupInventory', JSON.stringify(inventory));
      setPowerupInventory(inventory);
    } catch (error) {
    }
  };

  // Popup gÃ¶sterme helper fonksiyonu (1 saniye sonra otomatik kapanÄ±r)
  const showShopPopup = (message) => {
    setShopPurchasePopup({ visible: true, message });

    // Ã–nceki timer'Ä± temizle
    if (shopPopupTimeoutRef.current) {
      clearTimeout(shopPopupTimeoutRef.current);
    }

    // 1 saniye sonra otomatik kapat
    shopPopupTimeoutRef.current = setTimeout(() => {
      setShopPurchasePopup({ visible: false, message: '' });
    }, 1000);
  };

  // Skin satÄ±n alma fonksiyonu
  const buySkin = async (skinId) => {
    const skin = SKINS.find(s => s.id === skinId);
    if (!skin) return;

    // Zaten sahipse
    if (ownedSkins.includes(skinId)) {
      showShopPopup('Bu skine zaten sahipsin');
      return;
    }

    // Premium kontrol
    if (skin.isPremium && !premiumSkinsOwned) {
      showShopPopup('Premium Skin Paketi gerekli');
      return;
    }

    // Coin kontrol
    if (coins < skin.coinPrice) {
      showShopPopup(`${skin.coinPrice} coin gerekli`);
      return;
    }

    // SatÄ±n al
    const spent = await spendCoins(skin.coinPrice);
    if (spent) {
      const newOwnedSkins = [...ownedSkins, skinId];
      await saveOwnedSkinsToStorage(newOwnedSkins);

      // Otomatik seÃ§
      await saveSkinSelection(skinId);

      triggerHaptic('success');
      playSound(clickSound);
      showShopPopup(`${skin.name} satÄ±n alÄ±ndÄ±! âœ…`);
    }
  };

  // Skin seÃ§me fonksiyonu
  const selectSkin = async (skinId) => {
    if (!ownedSkins.includes(skinId)) {
      showShopPopup('Bu skine sahip deÄŸilsin');
      return;
    }

    await saveSkinSelection(skinId);
    triggerHaptic('light');
    playSound(clickSound);
  };

  // Power-up satÄ±n alma fonksiyonu
  const buyPowerup = async (powerupId) => {
    const powerup = POWERUPS.find(p => p.id === powerupId);
    if (!powerup) return;

    if (coins < powerup.coinPrice) {
      showShopPopup(`${powerup.coinPrice} coin gerekli`);
      return;
    }

    const spent = await spendCoins(powerup.coinPrice);
    if (spent) {
      const newInventory = {
        ...powerupInventory,
        [powerupId]: (powerupInventory[powerupId] || 0) + 1
      };
      await savePowerupInventory(newInventory);

      triggerHaptic('success');
      playSound(clickSound);

      // Custom popup gÃ¶ster - 1 saniye sonra otomatik kapat
      setPowerupPurchasePopup({ visible: true, message: `${powerup.name} satÄ±n alÄ±ndÄ±!` });

      // Ã–nceki timer'Ä± temizle
      if (powerupPopupTimeoutRef.current) {
        clearTimeout(powerupPopupTimeoutRef.current);
      }

      // 1 saniye sonra otomatik kapat
      powerupPopupTimeoutRef.current = setTimeout(() => {
        setPowerupPurchasePopup({ visible: false, message: '' });
      }, 1000);
    }
  };

  // Power-up kullanma fonksiyonu
  const usePowerup = async (powerupId) => {
    const powerup = POWERUPS.find(p => p.id === powerupId);
    if (!powerup) return;

    if (powerupInventory[powerupId] <= 0) {
      showShopPopup('Envanterde yok');
      return;
    }

    // Shield iÃ§in activePowerup kontrolÃ¼ yapma (Ã§Ã¼nkÃ¼ shield sÃ¼rekli aktif deÄŸil)
    if (powerup.effect !== 'shield' && activePowerup !== null) {
      showShopPopup('Zaten bir power-up aktif');
      return;
    }

    // Envanterden dÃ¼ÅŸ
    const newInventory = {
      ...powerupInventory,
      [powerupId]: powerupInventory[powerupId] - 1
    };
    await savePowerupInventory(newInventory);

    // Efekti aktif et
    if (powerup.effect === 'slowmotion') {
      setActivePowerup('slowmotion');
      triggerHaptic('medium');
      playSound(clickSound);

      if (powerupTimeoutRef.current) {
        clearTimeout(powerupTimeoutRef.current);
      }
      powerupTimeoutRef.current = setTimeout(() => {
        setActivePowerup(null);
      }, powerup.duration);
    } else if (powerup.effect === 'shield') {
      setShieldActive(true);
      shieldActiveRef.current = true; // Ref'i de set et
      triggerHaptic('medium');
      playSound(clickSound);
    } else if (powerup.effect === 'freeze') {
      setActivePowerup('freeze');
      triggerHaptic('medium');
      playSound(clickSound);

      if (powerupTimeoutRef.current) {
        clearTimeout(powerupTimeoutRef.current);
      }
      powerupTimeoutRef.current = setTimeout(() => {
        setActivePowerup(null);
      }, powerup.duration);
    }
  };

  // SeÃ§ili skin'in renklerini al
  const getCurrentSkinColors = () => {
    const skin = SKINS.find(s => s.id === selectedSkin);
    return skin ? skin.colors : SKINS[0].colors;
  };

  // SeÃ§ili skin'in temasÄ±nÄ± al
  const getCurrentSkinTheme = () => {
    const skin = SKINS.find(s => s.id === selectedSkin);
    return skin ? skin.theme : SKINS[0].theme;
  };

  // Monetizasyon baÅŸlatma
  const initializeMonetization = async () => {
    // AdMob baÅŸlat
    const adMobInitialized = await initializeAdMob();
    if (adMobInitialized) {
      loadInterstitialAd();
      loadRewardedAd();
    }

    // IAP baÅŸlat
    const iapCleanup = await initializeIAP();
    if (iapCleanup) {
      // IAP baÅŸarÄ±yla baÅŸlatÄ±ldÄ±
      const products = await loadProducts();
      setIapProducts(products);

      // SatÄ±n alÄ±nmÄ±ÅŸ Ã¼rÃ¼nleri kontrol et
      const removedAds = hasRemovedAds();
      const premiumSkins = hasPremiumSkins();
      setAdsRemoved(removedAds);
      setPremiumSkinsOwned(premiumSkins);
    }
  };

  // IAP fonksiyonlarÄ±
  const handlePurchase = async (productId) => {
    try {
      setIapLoading(true);
      await purchaseProduct(productId);

      // SatÄ±n alma baÅŸarÄ±lÄ±
      if (productId === IAP_PRODUCT_IDS.removeAds) {
        setAdsRemoved(true);
        showShopPopup('Reklamlar kaldÄ±rÄ±ldÄ±! ðŸŽ‰');
      } else if (productId === IAP_PRODUCT_IDS.premiumSkins) {
        setPremiumSkinsOwned(true);

        // TÃ¼m premium skinleri aÃ§
        const premiumSkinIds = SKINS.filter(s => s.isPremium).map(s => s.id);
        const newOwnedSkins = [...new Set([...ownedSkins, ...premiumSkinIds])];
        await saveOwnedSkinsToStorage(newOwnedSkins);

        showShopPopup('Premium skin paketi aÃ§Ä±ldÄ±! ðŸŽ¨');
      } else if (productId === IAP_PRODUCT_IDS.powerUpPack) {
        // Power-up paketi: 5 Slow Motion + 5 Shield + 5 Freeze
        const newInventory = {
          ...powerupInventory,
          slowmotion: (powerupInventory.slowmotion || 0) + 5,
          shield: (powerupInventory.shield || 0) + 5,
          freeze: (powerupInventory.freeze || 0) + 5,
        };
        await savePowerupInventory(newInventory);
        showShopPopup('Power-up paketi aÃ§Ä±ldÄ±! âš¡');
      } else if (productId === IAP_PRODUCT_IDS.coinPackSmall) {
        await addCoins(100);
        showShopPopup('100 coin kazandÄ±nÄ±z! ðŸ’°');
      } else if (productId === IAP_PRODUCT_IDS.coinPackMedium) {
        await addCoins(600);
        showShopPopup('600 coin kazandÄ±nÄ±z! ðŸ’°');
      } else if (productId === IAP_PRODUCT_IDS.coinPackLarge) {
        await addCoins(1500);
        showShopPopup('1500 coin kazandÄ±nÄ±z! ðŸ’°');
      }

      triggerHaptic('success');
      playSound(correctSound);
    } catch (error) {
      showShopPopup('SatÄ±n alma baÅŸarÄ±sÄ±z');
      console.error('Purchase error:', error);
    } finally {
      setIapLoading(false);
    }
  };

  const handleRestorePurchases = async () => {
    try {
      setIapLoading(true);
      const purchases = await restorePurchases();

      if (purchases.length > 0) {
        // SatÄ±n alÄ±nanlarÄ± kontrol et ve ayarla
        const removedAds = hasRemovedAds();
        const premiumSkins = hasPremiumSkins();
        setAdsRemoved(removedAds);
        setPremiumSkinsOwned(premiumSkins);

        // Premium skinler satÄ±n alÄ±ndÄ±ysa, tÃ¼m premium skinleri aÃ§
        if (premiumSkins) {
          const premiumSkinIds = SKINS.filter(s => s.isPremium).map(s => s.id);
          const newOwnedSkins = [...new Set([...ownedSkins, ...premiumSkinIds])];
          await saveOwnedSkinsToStorage(newOwnedSkins);
        }

        showShopPopup('SatÄ±n almalar geri yÃ¼klendi! âœ…');
        triggerHaptic('success');
      } else {
        showShopPopup('Geri yÃ¼klenecek satÄ±n alma yok');
      }
    } catch (error) {
      showShopPopup('Geri yÃ¼kleme baÅŸarÄ±sÄ±z');
      console.error('Restore error:', error);
    } finally {
      setIapLoading(false);
    }
  };

  // Rewarded video ile devam etme
  const handleContinueWithAd = () => {
    if (continueUsesToday >= 3) {
      showShopPopup('GÃ¼nlÃ¼k limit aÅŸÄ±ldÄ± ðŸ•');
      return;
    }

    if (!isRewardedAdReady()) {
      showShopPopup('Reklam hazÄ±r deÄŸil...');
      return;
    }

    const success = showRewardedAd((earnedReward) => {
      if (earnedReward) {
        // Oyuna devam et
        setContinueUsesToday(continueUsesToday + 1);
        // 3 saniye geri sayÄ±m baÅŸlat
        setCountdown(3);
        setGameState('playing');
        triggerHaptic('success');
      } else {
        showShopPopup('Reklam izlenmedi');
      }
    });

    if (!success) {
      showShopPopup('Reklam gÃ¶sterilemedi');
    }
  };

  // Rewarded video ile coin kazanma
  const handleWatchAdForCoins = () => {
    if (!isRewardedAdReady()) {
      showShopPopup('Reklam hazÄ±r deÄŸil...');
      return;
    }

    const success = showRewardedAd((earnedReward) => {
      if (earnedReward) {
        addCoins(25);
        triggerHaptic('success');
        playSound(correctSound);
        showShopPopup('25 coin kazandÄ±nÄ±z! ðŸ’°');
      }
    });

    if (!success) {
      showShopPopup('Reklam gÃ¶sterilemedi');
    }
  };

  // ============ MONETÄ°ZASYON FONKSÄ°YONLARI BÄ°TÄ°Åž ============

  // Ä°statistikleri yÃ¼kle
  const loadStats = async () => {
    try {
      const stats = await AsyncStorage.multiGet([
        'totalGamesPlayed',
        'totalScore',
        'totalCorrectMatches',
        'totalWrongMatches',
        'longestStreak',
      ]);

      stats.forEach(([key, value]) => {
        if (value !== null) {
          const numValue = parseInt(value);
          if (key === 'totalGamesPlayed') setTotalGamesPlayed(numValue);
          if (key === 'totalScore') setTotalScore(numValue);
          if (key === 'totalCorrectMatches') setTotalCorrectMatches(numValue);
          if (key === 'totalWrongMatches') setTotalWrongMatches(numValue);
          if (key === 'longestStreak') setLongestStreak(numValue);
        }
      });
    } catch (error) {
    }
  };

  // Ä°statistikleri kaydet
  const saveStats = async () => {
    try {
      await AsyncStorage.multiSet([
        ['totalGamesPlayed', totalGamesPlayed.toString()],
        ['totalScore', totalScore.toString()],
        ['totalCorrectMatches', totalCorrectMatches.toString()],
        ['totalWrongMatches', totalWrongMatches.toString()],
        ['longestStreak', longestStreak.toString()],
      ]);
    } catch (error) {
    }
  };

  // BaÅŸarÄ±mlarÄ± yÃ¼kle
  const loadAchievements = async () => {
    try {
      const savedAchievements = await AsyncStorage.getItem('achievements');

      if (savedAchievements) {
        const parsed = JSON.parse(savedAchievements);
        setAchievements(parsed);
      } else {
        // Ä°lk yÃ¼kleme - tÃ¼m baÅŸarÄ±mlarÄ± kilitle
        const initialAchievements = {};
        ACHIEVEMENTS_LIST.forEach(achievement => {
          initialAchievements[achievement.id] = { unlocked: false, progress: 0 };
        });
        setAchievements(initialAchievements);
      }
    } catch (error) {
    }
  };

  // BaÅŸarÄ±m kontrolÃ¼ ve kilidi aÃ§
  const checkAndUnlockAchievement = async (achievementId, currentProgress) => {

    const achievement = ACHIEVEMENTS_LIST.find(a => a.id === achievementId);
    if (!achievement) {
      return;
    }


    // AsyncStorage'dan gÃ¼ncel veriyi oku (race condition Ã¶nlemek iÃ§in)
    const savedAchievements = await AsyncStorage.getItem('achievements');
    const currentAchievements = savedAchievements ? JSON.parse(savedAchievements) : {};

    const currentState = currentAchievements[achievementId];

    if (currentState && currentState.unlocked) {
      return; // Zaten aÃ§Ä±lmÄ±ÅŸ
    }

    const newProgress = Math.min(currentProgress, achievement.requirement);
    const unlocked = newProgress >= achievement.requirement;


    const updatedAchievements = {
      ...currentAchievements,
      [achievementId]: { unlocked, progress: newProgress }
    };

    setAchievements(updatedAchievements);
    await AsyncStorage.setItem('achievements', JSON.stringify(updatedAchievements));

    if (unlocked && (!currentState || !currentState.unlocked)) {
      // Yeni baÅŸarÄ±m aÃ§Ä±ldÄ±!
      triggerHaptic('success');
      playSound(correctSound);
      showAchievementToast(achievement);
    }
  };

  // BaÅŸarÄ±m bildirimi gÃ¶ster (ArtÄ±k sadece session'a ekliyor, oyun sÄ±rasÄ±nda bildirim gÃ¶stermiyor)
  const showAchievementToast = (achievement) => {
    // Bu oyun oturumunda kazanÄ±lan baÅŸarÄ±mlarÄ± sakla
    setSessionAchievements(prev => {
      const alreadyAdded = prev.find(a => a.id === achievement.id);
      if (alreadyAdded) return prev;
      return [...prev, achievement];
    });
  };

  // GÃ¼nlÃ¼k giriÅŸ kontrolÃ¼
  const checkDailyLogin = async () => {
    try {
      const today = new Date().toDateString();
      const lastLogin = await AsyncStorage.getItem('lastLoginDate');
      const streak = await AsyncStorage.getItem('dailyLoginStreak');

      if (lastLogin !== today) {
        // Yeni gÃ¼n giriÅŸi
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toDateString();

        let newStreak = 1;
        if (lastLogin === yesterdayStr) {
          // ArdÄ±ÅŸÄ±k gÃ¼n
          newStreak = (streak ? parseInt(streak) : 0) + 1;
        }

        setDailyLoginStreak(newStreak);
        setLastLoginDate(today);
        setDailyRewardClaimed(false);

        await AsyncStorage.multiSet([
          ['lastLoginDate', today],
          ['dailyLoginStreak', newStreak.toString()],
          ['dailyRewardClaimed', 'false'],
        ]);

        // GÃ¼nlÃ¼k streak baÅŸarÄ±mlarÄ±nÄ± kontrol et
        checkAndUnlockAchievement('dedicated', newStreak);

        // GÃ¼nlÃ¼k gÃ¶revleri oluÅŸtur
        generateDailyTasks();
      } else {
        // AynÄ± gÃ¼n
        setDailyLoginStreak(streak ? parseInt(streak) : 1);
        setLastLoginDate(lastLogin);
        const claimed = await AsyncStorage.getItem('dailyRewardClaimed');
        setDailyRewardClaimed(claimed === 'true');
        loadDailyTasks();
      }
    } catch (error) {
    }
  };

  // GÃ¼nlÃ¼k gÃ¶revler oluÅŸtur
  const generateDailyTasks = () => {
    const tasks = [
      { id: 'play_5', title: '5 oyun oyna', target: 5, progress: 0, completed: false },
      { id: 'score_25', title: '25 puan kazan (tek oyunda)', target: 25, progress: 0, completed: false },
      { id: 'match_10', title: '10 doÄŸru eÅŸleÅŸme yap', target: 10, progress: 0, completed: false },
    ];
    setDailyTasks(tasks);
    AsyncStorage.setItem('dailyTasks', JSON.stringify(tasks));
  };

  // GÃ¼nlÃ¼k gÃ¶revleri yÃ¼kle
  const loadDailyTasks = async () => {
    try {
      const tasks = await AsyncStorage.getItem('dailyTasks');
      if (tasks) {
        setDailyTasks(JSON.parse(tasks));
      } else {
        generateDailyTasks();
      }
    } catch (error) {
    }
  };

  // GÃ¼nlÃ¼k gÃ¶rev gÃ¼ncelle
  const updateDailyTask = async (taskId, progress) => {
    const updatedTasks = dailyTasks.map(task => {
      if (task.id === taskId) {
        const newProgress = Math.min(progress, task.target);
        const completed = newProgress >= task.target;
        return { ...task, progress: newProgress, completed };
      }
      return task;
    });

    setDailyTasks(updatedTasks);
    await AsyncStorage.setItem('dailyTasks', JSON.stringify(updatedTasks));
  };

  // SkorlarÄ± sÄ±fÄ±rla
  const resetAllScores = async () => {
    try {
      await AsyncStorage.multiRemove([
        'highScore',
        'totalGamesPlayed',
        'totalScore',
        'totalCorrectMatches',
        'totalWrongMatches',
        'longestStreak',
        'achievements',
        'dailyLoginStreak',
        'lastLoginDate',
        'dailyTasks',
        'dailyRewardClaimed',
      ]);

      setHighScore(0);
      setTotalGamesPlayed(0);
      setTotalScore(0);
      setTotalCorrectMatches(0);
      setTotalWrongMatches(0);
      setLongestStreak(0);
      setCurrentStreak(0);

      const initialAchievements = {};
      ACHIEVEMENTS_LIST.forEach(achievement => {
        initialAchievements[achievement.id] = { unlocked: false, progress: 0 };
      });
      setAchievements(initialAchievements);

      setDailyLoginStreak(0);
      setDailyTasks([]);

      triggerHaptic('success');
      alert('TÃ¼m skorlar ve baÅŸarÄ±mlar sÄ±fÄ±rlandÄ±!');
    } catch (error) {
    }
  };

  // Tutorial'Ä± tamamla
  const completeTutorial = async () => {
    try {
      await AsyncStorage.setItem('hasSeenTutorial', 'true');
      setShowTutorial(false);
      setGameState('menu');
      setTutorialStep(0);
    } catch (error) {
    }
  };

  // Tutorial'Ä± tekrar gÃ¶ster
  const restartTutorial = useCallback(() => {
    setTutorialStep(0);
    setShowTutorial(true);
    setSettingsVisible(false); // AyarlarÄ± kapat
    setGameState('tutorial');
  }, []);

  // Ayarlar menÃ¼sÃ¼nÃ¼ aÃ§
  const openSettings = () => {
    setPreviousGameState(gameState); // Mevcut state'i kaydet
    setSettingsVisible(true);
    triggerHaptic('light');

    // EÄŸer oyun oynuyorsa, oyun loop'unu durdur (pause)
    if (gameState === 'playing' && gameLoop.current) {
      clearInterval(gameLoop.current);
      gameLoop.current = null;
    }
  };

  // Ayarlar menÃ¼sÃ¼nÃ¼ kapat
  const closeSettings = useCallback(() => {
    setSettingsVisible(false);
    triggerHaptic('light');

    // EÄŸer Ã¶nceki state playing ise, oyunu devam ettir (resume)
    if (previousGameState === 'playing') {
      // Game loop'u yeniden baÅŸlatmak iÃ§in gameState'i tetikle
      setGameState('playing');
    }
  }, [previousGameState]);

  // Switch handler'larÄ± - useCallback ile optimize edilmiÅŸ
  const handleSoundToggle = useCallback((value) => {
    setSoundEnabled(value);
    saveSetting('soundEnabled', value);
    if (hapticEnabled) {
      Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    }
  }, [hapticEnabled, saveSetting]);

  const handleMusicToggle = useCallback((value) => {
    setMusicEnabled(value);
    saveSetting('musicEnabled', value);
    if (hapticEnabled) {
      Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    }
  }, [hapticEnabled, saveSetting]);

  const handleHapticToggle = useCallback((value) => {
    setHapticEnabled(value);
    saveSetting('hapticEnabled', value);
    if (value) {
      Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    }
  }, [saveSetting]);

  // Oyunu baÅŸlat
  const startGame = () => {
    triggerHaptic('medium');
    playSound(clickSound);
    setGameState('playing');
    setScore(0);
    setBalls([]);
    setParticles([]);
    setSpeed(INITIAL_SPEED);
    ballIdCounter.current = 0;
    spawnTimer.current = 0;
    shieldUsedBallsRef.current.clear(); // Shield referansÄ±nÄ± temizle
    setShieldActive(false); // Shield'Ä± deaktif et
    shieldActiveRef.current = false; // Shield ref'ini de sÄ±fÄ±rla
    setSessionAchievements([]); // Yeni oyun baÅŸladÄ±ÄŸÄ±nda baÅŸarÄ±mlarÄ± temizle
    spawnBall();
  };

  // ParÃ§acÄ±k efekti oluÅŸtur
  const createParticles = (x, y, color, isSuccess = true) => {
    const particleCount = isSuccess ? 16 : 12; // Daha fazla parÃ§acÄ±k
    const newParticles = [];

    for (let i = 0; i < particleCount; i++) {
      const angle = (Math.PI * 2 * i) / particleCount;
      const velocity = isSuccess ? 8 : 5; // Daha hÄ±zlÄ±
      const particle = {
        id: particleIdCounter.current++,
        x: x + BALL_SIZE / 2,
        y: y + BALL_SIZE / 2,
        vx: Math.cos(angle) * velocity,
        vy: Math.sin(angle) * velocity,
        color: isSuccess ? color : '#FF3B30',
        opacity: new Animated.Value(1),
        size: isSuccess ? 12 : 10, // Daha bÃ¼yÃ¼k parÃ§acÄ±klar
      };
      newParticles.push(particle);

      // ParÃ§acÄ±ÄŸÄ± kaybet
      Animated.timing(particle.opacity, {
        toValue: 0,
        duration: 800,
        useNativeDriver: true,
      }).start();
    }

    setParticles(prev => [...prev, ...newParticles]);

    // ParÃ§acÄ±klarÄ± temizle
    setTimeout(() => {
      setParticles(prev => prev.filter(p => !newParticles.find(np => np.id === p.id)));
    }, 900);
  };

  // Yeni top oluÅŸtur
  const spawnBall = () => {
    setBalls((prevBalls) => {
      const topMostBall = prevBalls.length > 0
        ? prevBalls.reduce((top, ball) => ball.y < top.y ? ball : top, prevBalls[0])
        : null;

      const minSpawnDistance = BALL_SIZE * 1.5;
      if (topMostBall && topMostBall.y < minSpawnDistance) {
        return prevBalls;
      }

      // SeÃ§ili skin'in renklerini kullan
      const skinColors = getCurrentSkinColors();
      const randomColorIndex = Math.floor(Math.random() * COLORS.length);
      const skinColorIndex = randomColorIndex % skinColors.length;
      const randomColorHex = skinColors[skinColorIndex];
      const gameColor = COLORS[randomColorIndex];

      const newBall = {
        id: ballIdCounter.current++,
        colorId: gameColor.id,
        colorIndex: randomColorIndex, // Index ekle
        color: randomColorHex,
        x: Math.random() * (width - BALL_SIZE),
        y: -BALL_SIZE,
        fadeAnim: new Animated.Value(1),
        scaleAnim: new Animated.Value(1),
        targetX: null,
        targetColorIndex: null, // Index iÃ§in hedef ekle
        isDirected: false,
      };

      return [...prevBalls, newBall];
    });
  };

  // Countdown timer
  useEffect(() => {
    if (countdown > 0) {
      const timer = setTimeout(() => {
        setCountdown(countdown - 1);
        triggerHaptic('light');
      }, 1000);
      return () => clearTimeout(timer);
    }
  }, [countdown]);

  // Ana oyun dÃ¶ngÃ¼sÃ¼
  useEffect(() => {
    if (gameState === 'playing' && !settingsVisible && countdown === 0) {
      gameLoop.current = setInterval(() => {
        // Freeze efekti aktifse toplarÄ± dondur
        if (activePowerup === 'freeze') {
          return;
        }

        setBalls((prevBalls) => {
          const updatedBalls = prevBalls.map((ball) => {
            let newX = ball.x;
            // Slow motion efekti - hÄ±zÄ± yarÄ±ya dÃ¼ÅŸÃ¼r
            const currentSpeed = activePowerup === 'slowmotion' ? speed / 2 : speed;
            let newY = ball.y + currentSpeed;

            if (ball.isDirected && ball.targetX !== null) {
              const diff = ball.targetX - ball.x;
              const moveSpeed = 80;

              if (Math.abs(diff) > 1) {
                newX = ball.x + Math.sign(diff) * Math.min(Math.abs(diff), moveSpeed);
              } else {
                newX = ball.targetX;
              }
            }

            const sortedBalls = prevBalls
              .filter((b) => b.id !== ball.id && b.y > ball.y)
              .sort((a, b) => a.y - b.y);

            if (sortedBalls.length > 0) {
              const closestBallBelow = sortedBalls[0];
              const minDistance = BALL_SIZE * 2;

              if (closestBallBelow.y - newY < minDistance) {
                newY = ball.y;
              }
            }

            return {
              ...ball,
              x: newX,
              y: newY,
            };
          });

          const activeBalls = updatedBalls.filter((ball) => {
            // onLayout ile Ã¶lÃ§Ã¼lmÃ¼ÅŸ GERÃ‡EK pozisyonu kullan
            if (boxContainerY === null) {
              return true; // HenÃ¼z Ã¶lÃ§Ã¼lmemiÅŸse toplarÄ± tut
            }

            // Topun alt hizasÄ±nÄ± hesapla
            const ballBottom = ball.y + BALL_SIZE;

            // Ã‡arpÄ±ÅŸma kontrolÃ¼: Top container'a ulaÅŸtÄ± mÄ±?
            if (ballBottom >= boxContainerY) {
              return !checkBallReached(ball);
            }

            return true;
          });

          return activeBalls;
        });

        // ParÃ§acÄ±k animasyonu
        setParticles(prev => prev.map(p => ({
          ...p,
          x: p.x + p.vx,
          y: p.y + p.vy,
          vy: p.vy + 0.3, // YerÃ§ekimi
        })));

        spawnTimer.current++;
        if (spawnTimer.current >= 40) {
          spawnTimer.current = 0;
          spawnBall();
        }
      }, 16);

      return () => {
        if (gameLoop.current) {
          clearInterval(gameLoop.current);
        }
      };
    }
  }, [gameState, speed, settingsVisible, countdown, activePowerup]);

  // Top yakalama ve yÃ¶nlendirme
  const directBall = (ballId, targetColorId, boxIndex) => {
    triggerHaptic('light');
    playSound(clickSound);

    setBalls((prevBalls) => {
      return prevBalls.map((ball) => {
        if (ball.id === ballId && !ball.isDirected) {
          const boxWidth = width / 4;
          const targetX = boxIndex * boxWidth + (boxWidth / 2) - (BALL_SIZE / 2);

          // Top yakalandÄ±ÄŸÄ±nda hafif bir bÃ¼yÃ¼me animasyonu
          Animated.sequence([
            Animated.timing(ball.scaleAnim, {
              toValue: 1.2,
              duration: 100,
              useNativeDriver: true,
            }),
            Animated.timing(ball.scaleAnim, {
              toValue: 1,
              duration: 100,
              useNativeDriver: true,
            }),
          ]).start();

          return {
            ...ball,
            targetX: targetX,
            isDirected: true,
            targetColorId: targetColorId,
            targetColorIndex: boxIndex, // Index'i de kaydet
          };
        }
        return ball;
      });
    });
  };

  // Topu kutuya ulaÅŸtÄ±ÄŸÄ±nda kontrol et
  const checkBallReached = (ball) => {
    // onLayout ile Ã¶lÃ§Ã¼lmÃ¼ÅŸ GERÃ‡EK pozisyonu kullan
    if (boxContainerY === null) return false;

    // Shield ile zaten iÅŸaretlenmiÅŸ bir top mu kontrol et
    if (shieldUsedBallsRef.current.has(ball.id)) {
      return false; // Bu topu tekrar kontrol etme
    }

    // Topun alt hizasÄ±nÄ± hesapla
    const ballBottom = ball.y + BALL_SIZE;

    // Ã‡arpÄ±ÅŸma kontrolÃ¼
    if (ballBottom >= boxContainerY) {
      // Sadece yÃ¶nlendirilmiÅŸ toplarÄ± kontrol et
      if (ball.isDirected) {
        // Index bazlÄ± eÅŸleÅŸtirme (skinler iÃ§in)
        const isMatch = ball.colorIndex === ball.targetColorIndex;
        if (isMatch) {
          // DoÄŸru eÅŸleÅŸme - topu kaybet (kutuya girsin)
          triggerHaptic('success');
          playSound(correctSound);
          createParticles(ball.x, ball.y, ball.color, true);

          Animated.timing(ball.fadeAnim, {
            toValue: 0,
            duration: 200,
            useNativeDriver: true,
          }).start();

          setTimeout(() => {
            setBalls((prev) => prev.filter((b) => b.id !== ball.id));
          }, 200);

          // Streak gÃ¼ncelle
          const newStreak = currentStreak + 1;
          setCurrentStreak(newStreak);

          // Ä°statistikleri gÃ¼ncelle
          const newCorrectMatches = totalCorrectMatches + 1;
          setTotalCorrectMatches(newCorrectMatches);
          AsyncStorage.setItem('totalCorrectMatches', newCorrectMatches.toString());

          // Streak baÅŸarÄ±mlarÄ±nÄ± kontrol et
          checkAndUnlockAchievement('perfect_10', newStreak);
          checkAndUnlockAchievement('perfect_20', newStreak);

          // GÃ¼nlÃ¼k gÃ¶rev gÃ¼ncelle
          updateDailyTask('match_10', newCorrectMatches % 1000);

          setScore((prevScore) => {
            const newScore = prevScore + 1;

            if (newScore % 5 === 0) {
              setSpeed((prevSpeed) => prevSpeed + SPEED_INCREMENT);
            }

            return newScore;
          });

          return true;
        } else {
          // YanlÄ±ÅŸ eÅŸleÅŸme - Game Over
          // Shield kontrolÃ¼
          if (shieldActiveRef.current) {
            // Shield kullanÄ±ldÄ±, oyun bitmesin, topu kaldÄ±r
            setShieldActive(false);
            shieldActiveRef.current = false;
            shieldUsedBallsRef.current.add(ball.id); // Bu topu iÅŸaretle
            triggerHaptic('warning');
            playSound(clickSound);

            // Topu kaldÄ±r
            Animated.timing(ball.fadeAnim, {
              toValue: 0,
              duration: 200,
              useNativeDriver: true,
            }).start();

            setTimeout(() => {
              setBalls((prev) => prev.filter((b) => b.id !== ball.id));
              shieldUsedBallsRef.current.delete(ball.id); // Temizle
            }, 200);

            // Shield kullanÄ±ldÄ± - ekranda gÃ¶sterge zaten var
            return true;
          } else {
            // EÅŸleÅŸme yok - Game Over
            triggerHaptic('error');
            playSound(wrongSound);
            createParticles(ball.x, ball.y, ball.color, false);
            endGame();
            return true;
          }
        }
      } else {
        // YÃ¶nlendirilmemiÅŸ top kutuya ulaÅŸtÄ± - Game Over
        if (shieldActiveRef.current) {
          // Shield kullanÄ±ldÄ±
          setShieldActive(false);
          shieldActiveRef.current = false;
          shieldUsedBallsRef.current.add(ball.id); // Bu topu iÅŸaretle
          triggerHaptic('warning');
          playSound(clickSound);

          Animated.timing(ball.fadeAnim, {
            toValue: 0,
            duration: 200,
            useNativeDriver: true,
          }).start();

          setTimeout(() => {
            setBalls((prev) => prev.filter((b) => b.id !== ball.id));
            shieldUsedBallsRef.current.delete(ball.id); // Temizle
          }, 200);

          return true;
        } else {
          // YÃ¶nlendirilmemiÅŸ top - Game Over
          triggerHaptic('error');
          playSound(wrongSound);
          endGame();
          return true;
        }
      }
    }
    return false;
  };

  // Oyunu bitir
  const endGame = async () => {
    setGameState('gameOver');
    saveHighScore(score);

    if (gameLoop.current) {
      clearInterval(gameLoop.current);
    }

    // Ä°statistikleri gÃ¼ncelle
    const newTotalGames = totalGamesPlayed + 1;
    const newTotalScore = totalScore + score;
    const newTotalWrong = totalWrongMatches + 1;

    setTotalGamesPlayed(newTotalGames);
    setTotalScore(newTotalScore);
    setTotalWrongMatches(newTotalWrong);

    // Streak kontrolÃ¼
    if (currentStreak > longestStreak) {
      setLongestStreak(currentStreak);
    }
    setCurrentStreak(0);

    // Ä°statistikleri kaydet
    await AsyncStorage.multiSet([
      ['totalGamesPlayed', newTotalGames.toString()],
      ['totalScore', newTotalScore.toString()],
      ['totalWrongMatches', newTotalWrong.toString()],
      ['longestStreak', Math.max(currentStreak, longestStreak).toString()],
    ]);

    // BaÅŸarÄ±mlarÄ± kontrol et (sÄ±rayla - race condition Ã¶nlemek iÃ§in)
    await checkAndUnlockAchievement('first_game', newTotalGames);
    await checkAndUnlockAchievement('century', newTotalGames);
    await checkAndUnlockAchievement('beginner', score);
    await checkAndUnlockAchievement('expert', score);
    await checkAndUnlockAchievement('master', score);
    await checkAndUnlockAchievement('legend', score);

    // GÃ¼nlÃ¼k gÃ¶revleri gÃ¼ncelle
    updateDailyTask('play_5', newTotalGames % 1000); // BugÃ¼nkÃ¼ oyun sayÄ±sÄ±
    if (score >= 25) {
      updateDailyTask('score_25', 25);
    }

    // Coin kazandÄ±r (puana gÃ¶re)
    await addCoins(score);

    // Interstitial reklam gÃ¶ster (her 3-4 oyunda bir, reklamsÄ±z deÄŸilse)
    const newGamesCount = gamesPlayedSinceAd + 1;
    setGamesPlayedSinceAd(newGamesCount);

    if (!adsRemoved && newGamesCount >= 3) {
      // Reklam gÃ¶ster
      setTimeout(() => {
        if (isInterstitialReady()) {
          showInterstitialAd();
          setGamesPlayedSinceAd(0);
        }
      }, 1000); // 1 saniye gecikme (Game Over ekranÄ± gÃ¶rÃ¼nsÃ¼n)
    }
  };

  // Yasal belgeleri gÃ¶ster
  const showPrivacyPolicy = useCallback(() => {
    setModalTitle('Gizlilik PolitikasÄ±');
    setModalContent('privacy');
    setModalVisible(true);
  }, []);

  const showTermsOfService = useCallback(() => {
    setModalTitle('KullanÄ±m ÅžartlarÄ±');
    setModalContent('terms');
    setModalVisible(true);
  }, []);

  // Link aÃ§ma fonksiyonu
  const openLink = useCallback(async (url) => {
    try {
      const supported = await Linking.canOpenURL(url);
      if (supported) {
        await Linking.openURL(url);
      } else {
      }
    } catch (error) {
    }
  }, []);

  // Ayarlar Modal - useMemo ile optimize edilmiÅŸ
  const SettingsModalComponent = useMemo(() => (
    <SettingsModal
      visible={settingsVisible}
      soundEnabled={soundEnabled}
      musicEnabled={musicEnabled}
      hapticEnabled={hapticEnabled}
      highScore={highScore}
      totalGamesPlayed={totalGamesPlayed}
      totalScore={totalScore}
      totalCorrectMatches={totalCorrectMatches}
      longestStreak={longestStreak}
      dailyLoginStreak={dailyLoginStreak}
      onClose={closeSettings}
      onSoundToggle={handleSoundToggle}
      onMusicToggle={handleMusicToggle}
      onHapticToggle={handleHapticToggle}
      onRestartTutorial={restartTutorial}
      onShowPrivacyPolicy={showPrivacyPolicy}
      onShowTermsOfService={showTermsOfService}
      onOpenLink={openLink}
    />
  ), [settingsVisible, soundEnabled, musicEnabled, hapticEnabled, highScore, totalGamesPlayed, totalScore, totalCorrectMatches, longestStreak, dailyLoginStreak, handleSoundToggle, handleMusicToggle, handleHapticToggle, closeSettings, restartTutorial, showPrivacyPolicy, showTermsOfService, openLink]);

  // Top bileÅŸeni
  // Skinler ekranÄ±
  if (gameState === 'skins') {
    return (
      <SkinsScreen
        coins={coins}
        ownedSkins={ownedSkins}
        selectedSkin={selectedSkin}
        premiumSkinsOwned={premiumSkinsOwned}
        onNavigateMenu={() => setGameState('menu')}
        onSelectSkin={selectSkin}
        onBuySkin={buySkin}
        onNavigateStore={() => setGameState('store')}
        onTriggerHaptic={triggerHaptic}
        onPlaySound={playSound}
        clickSound={clickSound}
      />
    );
  }

  // Power-ups ekranÄ±
  if (gameState === 'powerups') {
    const currentTheme = getCurrentSkinTheme();

    return (
      <PowerupsScreen
        coins={coins}
        powerupInventory={powerupInventory}
        currentTheme={currentTheme}
        powerupPurchasePopup={powerupPurchasePopup}
        onNavigateMenu={() => setGameState('menu')}
        onBuyPowerup={buyPowerup}
        onNavigateStore={() => setGameState('store')}
        onClosePowerupPopup={() => setPowerupPurchasePopup({ visible: false, message: '' })}
        onTriggerHaptic={triggerHaptic}
        onPlaySound={playSound}
        clickSound={clickSound}
      />
    );
  }

  // BaÅŸarÄ±mlar ekranÄ±
  if (gameState === 'achievements') {
    return (
      <AchievementsScreen
        achievements={achievements}
        onNavigateMenu={() => setGameState('menu')}
        onTriggerHaptic={triggerHaptic}
      />
    );
  }

  // GÃ¼nlÃ¼k GÃ¶revler ekranÄ±
  if (gameState === 'dailyTasks') {
    return (
      <DailyTasksScreen
        dailyLoginStreak={dailyLoginStreak}
        dailyTasks={dailyTasks}
        onNavigateMenu={() => setGameState('menu')}
        onTriggerHaptic={triggerHaptic}
      />
    );
  }

  // MaÄŸaza ekranÄ±
  if (gameState === 'store') {
    const currentTheme = getCurrentSkinTheme();

    return (
      <StoreScreen
        coins={coins}
        adsRemoved={adsRemoved}
        premiumSkinsOwned={premiumSkinsOwned}
        iapLoading={iapLoading}
        currentTheme={currentTheme}
        shopPurchasePopup={shopPurchasePopup}
        onNavigateMenu={() => setGameState('menu')}
        onPurchase={handlePurchase}
        onRestorePurchases={handleRestorePurchases}
        onWatchAdForCoins={handleWatchAdForCoins}
        onCloseShopPopup={() => setShopPurchasePopup({ visible: false, message: '' })}
        onTriggerHaptic={triggerHaptic}
      />
    );
  }

  // Tutorial ekranÄ±
  // Tutorial ekranÄ±
  if (gameState === 'tutorial') {
    return (
      <TutorialScreen
        tutorialStep={tutorialStep}
        onCompleteTutorial={completeTutorial}
        onNextStep={() => setTutorialStep(tutorialStep + 1)}
        onTriggerHaptic={triggerHaptic}
      />
    );
  }
  // MenÃ¼ ekranÄ±
  if (gameState === 'menu') {
    return (
      <MenuScreen
        coins={coins}
        highScore={highScore}
        modalVisible={modalVisible}
        modalTitle={modalTitle}
        modalContent={modalContent}
        onStartGame={startGame}
        onNavigate={(screen) => setGameState(screen)}
        onOpenSettings={openSettings}
        onShowPrivacyPolicy={showPrivacyPolicy}
        onShowTermsOfService={showTermsOfService}
        onOpenLink={openLink}
        onCloseModal={() => setModalVisible(false)}
        onTriggerHaptic={triggerHaptic}
        onPlaySound={playSound}
        clickSound={clickSound}
        SettingsModal={SettingsModalComponent}
      />
    );
  }
  // Oyun bitti ekranÄ±
  if (gameState === 'gameOver') {
    return (
      <GameOverScreen
        score={score}
        highScore={highScore}
        sessionAchievements={sessionAchievements}
        continueUsesToday={continueUsesToday}
        isRewardedAdReady={isRewardedAdReady}
        onStartGame={startGame}
        onNavigateMenu={() => setGameState('menu')}
        onContinueWithAd={handleContinueWithAd}
        onTriggerHaptic={triggerHaptic}
        SettingsModal={SettingsModalComponent}
      />
    );
  }
  // Oyun ekranÄ±
  const currentTheme = getCurrentSkinTheme();

  return (
    <GameScreen
      score={score}
      highScore={highScore}
      balls={balls}
      particles={particles}
      countdown={countdown}
      adsRemoved={adsRemoved}
      currentTheme={currentTheme}
      powerupInventory={powerupInventory}
      activePowerup={activePowerup}
      shieldActive={shieldActive}
      powerupPurchasePopup={powerupPurchasePopup}
      onOpenSettings={openSettings}
      onUsePowerup={usePowerup}
      onDirectBall={directBall}
      onBoxLayout={(event) => {
        const { y } = event.nativeEvent.layout;
        const adjustedY = y - 95 - 50;
        setBoxContainerY(adjustedY);
      }}
      onClosePowerupPopup={() => setPowerupPurchasePopup({ visible: false, message: '' })}
      getCurrentSkinColors={getCurrentSkinColors}
      SettingsModal={SettingsModalComponent}
    />
  );
}
